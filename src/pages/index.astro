---
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/Layout.astro';
import Header from '@/components/site/Header.astro';
import Footer from '@/components/site/Footer.astro';
import { generateCanonicalUrl } from '@/utils/seo';

const posts = (await getCollection('posts', ({ data }) => {
  return import.meta.env.PROD ? !data.draft : true;
})).sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const canonical = generateCanonicalUrl('/');

// Group posts by year
const groupedPosts = posts.reduce((acc, post) => {
  const year = post.data.date.getFullYear();
  if (!acc[year]) acc[year] = [];
  acc[year].push(post);
  return acc;
}, {} as Record<number, typeof posts>);

const years = Object.keys(groupedPosts).map(Number).sort((a, b) => b - a);
---

<BaseLayout
  title="Home"
  description="A space to share thoughts, ideas, and learnings."
  canonical={canonical}
>
  <Header />
  
  <main class="py-20">
    <header class="mb-12">
      <h1 class="mb-4">Hello ðŸ‘‹</h1>
      <p class="text-xl text-muted-foreground">
        This is my personal space to share thoughts, ideas, sadness, pain, and achievements.
      </p>
    </header>
    
    <!-- Posts List -->
    <section>
      <h2 class="sr-only">Recent Posts</h2>
      
      {posts.length !== 0 && (
        <div class="space-y-4">
          {years.map((year) => (
            <div class="relative grid grid-cols-[1fr_auto] gap-4 items-start sm:grid-cols-[100px_1fr_auto] sm:gap-8">
              <div class="text-muted-foreground font-medium hidden sm:block">
                {year}
              </div>
              <div class="contents sm:block sm:col-start-2">
                <div class="space-y-4 w-full">
                  {groupedPosts[year].map((post) => (
                    <article class="group flex justify-between items-baseline gap-4">
                      <a 
                        href={`/posts/${post.slug}`}
                        class="text-foreground no-underline hover:text-primary-300 transition-colors truncate"
                      >
                        {post.data.title}
                      </a>
                      <span class="text-sm text-muted-foreground font-mono tabular-nums shrink-0">
                        {post.data.readingTime ? `${post.data.readingTime} min read` : ''}
                      </span>
                    </article>
                  ))}
                </div>
              </div>
            </div>
          ))}
        </div>
      )}
    </section>
  </main>
  
  <Footer />
</BaseLayout>
