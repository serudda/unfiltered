---
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/Layout.astro';
import Header from '@/components/site/Header.astro';
import Footer from '@/components/site/Footer.astro';
import { generateCanonicalUrl } from '@/utils/seo';

const posts = (await getCollection('posts', ({ data }) => {
  return import.meta.env.PROD ? !data.draft : true;
})).sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const canonical = generateCanonicalUrl('/');

// Group posts by year
const groupedPosts = posts.reduce((acc, post) => {
  const year = post.data.date.getFullYear();
  if (!acc[year]) acc[year] = [];
  acc[year].push(post);
  return acc;
}, {} as Record<number, typeof posts>);

const years = Object.keys(groupedPosts).map(Number).sort((a, b) => b - a);
---

<BaseLayout
  title="Home"
  description="A space to share thoughts, ideas, and learnings."
  canonical={canonical}
>
  <Header />
  
  <main class="py-20">
    <header class="mb-10">
      <h1 class="mb-4 font-serif text-xl font-semibold">Hi, I'm Sergio Ruiz <span class="text-muted-foreground text-sm">(known as "Serudda") üëã</span></h1>
      <p class="font-serif text-foreground leading-relaxed">
        I'm a <a href="https://github.com/serudda" target="_blank" class="text-foreground hover:text-primary-300 transition-colors border-b border-primary-300/50 hover:border-primary-300">Product Engineer</a> now‚Äîyeah, used to be "UX Engineer" ü§∑‚Äç‚ôÇÔ∏è, and I've been coding for 15 years. Titles change, but I haven't: I just love to create. Whether I'm building software, recording <a href="#" class="text-foreground hover:text-primary-300 transition-colors border-b border-primary-300/50 hover:border-primary-300">videos</a>, or playing Magic: The Gathering, I'm always making something. I'm pretty low-key these days, mostly hanging out with my wife, kids, and <a href="#" class="text-foreground hover:text-primary-300 transition-colors border-b border-primary-300/50 hover:border-primary-300">dogs</a>.
      </p>
    </header>

    <hr class="my-12 border-dashed-x" />
    
    <!-- Posts List -->
    <section>
      <h2 class="mb-6 font-serif text-xl font-semibold">Recent Posts</h2>
      
      {posts.length !== 0 && (
        <div class="space-y-4">
          {years.map((year) => (
            <div class="relative grid grid-cols-[1fr_auto] gap-4 items-start sm:grid-cols-[100px_1fr_auto] sm:gap-8">
              <div class="text-muted-foreground font-medium hidden sm:block">
                {year}
              </div>
              <div class="contents sm:block sm:col-start-2">
                <div class="space-y-4 w-full">
                  {groupedPosts[year].map((post) => (
                    <article class="group flex justify-between items-baseline gap-4">
                      <a 
                        href={`/posts/${post.slug}`}
                        class="text-foreground no-underline hover:text-primary-300 transition-colors truncate"
                      >
                        {post.data.title}
                      </a>
                      <span class="text-sm text-muted-foreground font-mono tabular-nums shrink-0">
                        {post.data.readingTime ? `${post.data.readingTime} min read` : ''}
                      </span>
                    </article>
                  ))}
                </div>
              </div>
            </div>
          ))}
        </div>
      )}
    </section>
  </main>
</BaseLayout>
