---
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/Layout.astro';
import Header from '@/components/site/Header.astro';
import Tag from '@/components/ui/Tag.astro';
import SkillList from '@/components/skills/SkillList.astro';
import { generateCanonicalUrl } from '@/utils/seo';

// Get all vaults (filter drafts in production)
const vaults = (await getCollection('vaults', ({ data }) => {
  return import.meta.env.PROD ? !data.draft : true;
})).sort((a, b) => b.data.lastUpdated.getTime() - a.data.lastUpdated.getTime());

// Get all skills (filter drafts in production)
const allSkills = (await getCollection('skills', ({ data }) => {
  return import.meta.env.PROD ? !data.draft : true;
})).sort((a, b) => b.data.lastUpdated.getTime() - a.data.lastUpdated.getTime());

// Group skills by vault
const skillsByVault = new Map<string, typeof allSkills>();
const independentSkills: typeof allSkills = [];

allSkills.forEach((skill) => {
  if (skill.data.vault) {
    const vaultSkills = skillsByVault.get(skill.data.vault) || [];
    vaultSkills.push(skill);
    skillsByVault.set(skill.data.vault, vaultSkills);
  } else {
    independentSkills.push(skill);
  }
});

const canonical = generateCanonicalUrl('/skills/');
---

<BaseLayout
  title="Skills"
  description="Claude Code skills and vaults I've created. Each skill is a custom command you can install and use."
  canonical={canonical}
  lang="en"
>
  <Header />

  <main class="py-20">
    <header class="mb-10">
      <h1 class="mb-4 font-serif text-xl font-semibold">Skills</h1>
      <p class="font-serif text-foreground tracking-wide leading-relaxed">
        Custom <a href="https://docs.anthropic.com/en/docs/claude-code" target="_blank" class="text-foreground hover:text-primary-300 transition-colors border-b border-primary-300/50 hover:border-primary-300">Claude Code</a> skills and vaults I've built. Each one is a slash command you can install and use in your own workflow.
      </p>
    </header>

    <hr class="my-12 border-dashed-x" />

    <!-- Vaults Section -->
    {vaults.length > 0 && (
      <section class="mb-12">
        <h2 class="text-sm font-semibold text-muted-foreground uppercase tracking-wider mb-6">Vaults</h2>
        <div class="space-y-6">
          {vaults.map((vault) => {
            const vaultSkills = skillsByVault.get(vault.slug) || [];
            return (
              <div class="border border-border rounded-lg overflow-hidden">
                {/* Vault Header */}
                <a
                  href={`/skills/vaults/${vault.slug}/`}
                  class="block p-4 hover:bg-card/50 transition-colors border-b border-border"
                >
                  <div class="flex items-start justify-between gap-4">
                    <div class="flex-1 min-w-0">
                      <div class="flex items-center gap-3 mb-1">
                        <h3 class="font-semibold text-foreground hover:text-primary-300 transition-colors">
                          {vault.data.name}
                        </h3>
                        <span class="text-xs text-muted-foreground">
                          {vaultSkills.length} skills
                        </span>
                      </div>
                      <p class="text-sm text-muted-foreground">
                        {vault.data.tagline}
                      </p>
                    </div>
                    <span class="text-xs text-muted-foreground shrink-0">
                      v{vault.data.version}
                    </span>
                  </div>
                </a>

                {/* Skills within vault - clickable links to individual pages */}
                {vaultSkills.length > 0 && (
                  <SkillList skills={vaultSkills}/>
                )}
              </div>
            );
          })}
        </div>
      </section>
    )}

    <!-- Independent Skills Section -->
    {independentSkills.length > 0 && (
      <section>
        <h2 class="text-sm font-semibold text-muted-foreground uppercase tracking-wider mb-6">Skills</h2>
        <div class="space-y-4">
          {independentSkills.map((skill) => {
            return (
              <a
                href={`/skills/${skill.slug}/`}
                class="block p-4 -mx-4 rounded-lg hover:bg-card transition-colors group"
              >
                <div class="flex items-start justify-between gap-4">
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-3 mb-1">
                      <h3 class="font-semibold text-foreground group-hover:text-primary-300 transition-colors">
                        {skill.data.name}
                      </h3>
                      <Tag color="purple" size="xs">
                        {skill.data.installCommand}
                      </Tag>
                    </div>
                    <p class="text-sm text-muted-foreground line-clamp-2">
                      {skill.data.tagline}
                    </p>
                  </div>
                  <span class="text-xs text-muted-foreground shrink-0">
                    v{skill.data.version}
                  </span>
                </div>
              </a>
            );
          })}
        </div>
      </section>
    )}

    {/* Empty state */}
    {vaults.length === 0 && allSkills.length === 0 && (
      <p class="text-muted-foreground">No skills or vaults yet. Check back soon.</p>
    )}
  </main>
</BaseLayout>
