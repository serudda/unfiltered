---
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import BaseLayout from '@/layouts/Layout.astro';
import Header from '@/components/site/Header.astro';
import { generateCanonicalUrl } from '@/utils/seo';

export const getStaticPaths = (() => {
  return [
    { params: { lang: 'en' } },
    { params: { lang: 'es' } },
  ];
}) satisfies GetStaticPaths;

const { lang } = Astro.params as { lang: 'en' | 'es' };

// Filter posts by language
const posts = (await getCollection('posts', ({ data }) => {
  const isNotDraft = import.meta.env.PROD ? !data.draft : true;
  const matchesLang = data.lang === lang;
  return isNotDraft && matchesLang;
})).sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const canonical = generateCanonicalUrl(`/${lang}/`);

// Group posts by year
const groupedPosts = posts.reduce((acc, post) => {
  const year = post.data.date.getFullYear();
  if (!acc[year]) acc[year] = [];
  acc[year].push(post);
  return acc;
}, {} as Record<number, typeof posts>);

const years = Object.keys(groupedPosts).map(Number).sort((a, b) => b - a);

// i18n strings
const strings = {
  en: {
    title: 'Home',
    description: 'A space to share thoughts, ideas, and learnings.',
    greeting: "Sergio Ruiz",
    nickname: '(known as "Serudda")',
    bio: `
    For a long time, I lived trapped in what I now call the “golden handcuffs.” During my time at Eden, I was earning $11,000 a month, a privileged figure for anyone in Colombia, but it was costing me my life. I felt obsolete. The Sergio who was once athletic, impatient to create, and full of curiosity had turned into someone scraping the bottom of a job that no longer inspired him, driven solely by an intrinsic fear of bankruptcy.

    The breaking point came in an office, trying to negotiate a raise that, deep down, I knew I didn’t deserve—because the company had turned me gray. Having to lower my head in front of a boss who asked me to “put your ass in” for six more months to prove my worth was the spark. At 40 years old, I realized I couldn’t spend what little energy I have left building someone else’s dream. I decided my time was worth more than those green bills.

    Today, I have “bought back my time.” I’ve reduced my income to reclaim my freedom. My day starts at 5:30 a.m., not to meet a schedule, but to strengthen my core: I read, write, take notes, and rebuild my intellectual foundations. I’ve gone from being a developer who felt obsolete to a constant learner who understands that, in a world saturated with artificial intelligence, human authenticity is the scarcest and most valuable asset.
    
    My mission now is to help others give themselves that space to grow—to stop selling their time for crumbs of security and to build a voice of their own that transcends technique and touches something real.
    `,
    recentPosts: 'Recent Posts',
    minRead: 'min read',
  },
  es: {
    title: 'Inicio',
    description: 'Un espacio para compartir pensamientos, ideas y aprendizajes.',
    greeting: 'Sergio Ruiz',
    nickname: '(conocido como "Serudda")',
    bio: `
    Por mucho tiempo, viví atrapado en lo que hoy llamo las "esposas de oro". En mi etapa en Eden, llegué a ganar 11,000 dólares mensuales, una cifra privilegiada para cualquiera en Colombia, pero que a mí me estaba costando la vida. Me sentía obsoleto. El Sergio que alguna vez fue atlético, impaciente por crear y lleno de curiosidad, se había convertido en alguien que "rascaba" el fondo de un empleo que no le motivaba, solo por el temor intrínseco a la bancarrota.

    El punto de quiebre llegó en una oficina, tratando de negociar un aumento que en el fondo sabía que no merecía, porque la empresa me había vuelto gris. Tener que agachar la cabeza ante un jefe que me pedía "meterle el culo" durante seis meses más para demostrar mi valor fue la chispa. A mis 40 años, entendí que no podía gastar la poca energía que me queda en construir el sueño de otro. Decidí que mi tiempo valía más que esos billetes verdes.
    
    Hoy, he "comprado mi tiempo". He reducido mis ingresos para recuperar mi libertad. Mi día empieza a las 5:30 a.m., no para cumplir un horario, sino para fortalecer mi core: leo, escribo, tomo notas y reconstruyo mis bases intelectuales. He pasado de ser un desarrollador que se sentía obsoleto a un aprendiz constante que entiende que, en un mundo saturado de inteligencia artificial, la autenticidad humana es el activo más escaso y valioso.
    
    Mi misión ahora es ayudar a otros a darse ese espacio para crecer, a dejar de vender su tiempo por migajas de seguridad y a construir una voz propia que trascienda la técnica y toque fibras reales.`,
    recentPosts: 'Posts Recientes',
    minRead: 'min de lectura',
  },
};

const t = strings[lang];
---

<BaseLayout
  title={t.title}
  description={t.description}
  canonical={canonical}
  lang={lang}
>
  <Header lang={lang} />
  
  <main class="py-20">
    <header class="mb-10">
      <h1 class="mb-4 font-serif text-xl font-semibold">{t.greeting} <span class="text-muted-foreground text-sm">{t.nickname}</span></h1>
      <p class="font-serif text-foreground tracking-wide leading-relaxed" set:html={t.bio} />
    </header>

    <hr class="my-12 border-dashed-x" />
    
    <!-- Posts List -->
    <section>
      <h2 class="mb-6 font-serif text-xl font-semibold">{t.recentPosts}</h2>
      
      {posts.length !== 0 && (
        <div class="space-y-4">
          {years.map((year) => (
            <div class="relative grid grid-cols-[1fr_auto] gap-4 items-start sm:grid-cols-[100px_1fr_auto] sm:gap-8">
              <div class="text-muted-foreground font-medium hidden sm:block">
                {year}
              </div>
              <div class="contents sm:block sm:col-start-2">
                <div class="space-y-4 w-full">
                  {groupedPosts[year].map((post) => (
                    <article class="group flex justify-between items-baseline gap-4">
                      <a 
                        href={`/${lang}/posts/${post.slug}`}
                        class="text-foreground no-underline hover:text-primary-300 transition-colors truncate"
                      >
                        {post.data.title}
                      </a>
                      <span class="text-sm text-muted-foreground font-mono tabular-nums shrink-0">
                        {post.data.readingTime ? `${post.data.readingTime} ${t.minRead}` : ''}
                      </span>
                    </article>
                  ))}
                </div>
              </div>
            </div>
          ))}
        </div>
      )}
    </section>
  </main>
</BaseLayout>