---
import type { CollectionEntry } from 'astro:content';
import BaseLayout from './Layout.astro';
import Header from '@/components/site/Header.astro';
import Tag from '@/components/ui/Tag.astro';
import { formatRelativeTime } from '@/utils/dates';

interface Props {
  frontmatter: CollectionEntry<'vaults'>['data'];
  canonical: string;
  skills: CollectionEntry<'skills'>[];
}

const { frontmatter, canonical, skills } = Astro.props;

// Format date
const dateObj = new Date(frontmatter.lastUpdated);
const day = dateObj.getDate();
const year = dateObj.getFullYear();
const month = dateObj.toLocaleDateString('en-US', { month: 'long' });
const capitalizedMonth = month.charAt(0).toUpperCase() + month.slice(1);

const formattedDate = `${capitalizedMonth} ${day}, ${year}`;
const relativeTime = formatRelativeTime(frontmatter.lastUpdated);
---


<BaseLayout
  title={frontmatter.name}
  description={frontmatter.tagline}
  canonical={canonical}
  lang="en"
>
  <Header />

  <main class="py-20">
    <article>
      <!-- Vault Header -->
      <header>
        <div class="flex items-center gap-3 mb-4">
          <Tag color="purple" size="xs">
            vault
          </Tag>
          <span class="text-xs text-muted-foreground">v{frontmatter.version}</span>
          <span class="text-xs text-muted-foreground">•</span>
          <span class="text-xs text-muted-foreground">{skills.length} skills</span>
        </div>

        <h1 class="mb-2 text-2xl font-bold">{frontmatter.name}</h1>
        <p class="text-xl text-muted-foreground font-serif">{frontmatter.tagline}</p>

        <div class="flex items-center gap-2 mt-4 text-sm text-muted-foreground">
          <span>Last updated:</span>
          <time datetime={frontmatter.lastUpdated.toISOString()}>
            {formattedDate} ({relativeTime})
          </time>
        </div>
      </header>

      <!-- Skills in this vault (dynamically fetched) -->
      {skills.length > 0 && (
        <section class="mt-10">
          <h2 class="text-lg font-semibold mb-4">Skills in this vault</h2>
          <div class="border border-border rounded-lg overflow-hidden">
            {skills.map((skill, index) => (
              <a
                href={`/skills/${skill.slug}/`}
                class={`block px-4 py-4 hover:bg-card/50 transition-colors ${index > 0 ? 'border-t border-border' : ''}`}
              >
                <div class="flex items-start gap-3">
                  <Tag color="purple" size="xs">
                    {skill.data.installCommand}
                  </Tag>
                  <div class="min-w-0">
                    <p class="font-medium text-foreground">{skill.data.name}</p>
                    <p class="text-sm text-muted-foreground mt-1">{skill.data.tagline}</p>
                  </div>
                </div>
              </a>
            ))}
          </div>
        </section>
      )}

      <hr class="border-dashed-x my-10" />

      <!-- Vault Content -->
      <div class="font-serif text-xl text-foreground">
        <slot />
      </div>

      <!-- Back to Skills -->
      <div class="mt-16 pt-8 border-t border-border">
        <a
          href="/skills/"
          class="text-sm text-muted-foreground hover:text-primary-300 transition-colors"
        >
          ← Back to all skills
        </a>
      </div>
    </article>
  </main>
</BaseLayout>
